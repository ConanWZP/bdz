#include "termoresistor.h"
#include <avr/io.h>
#include <avr/pgmspace.h>

// ???????? ???????????, ???????????? ???? ????? ??????????? ??? ?????? ??????? ???????? ???????
#define TEMPERATURE_UNDER 0
// ???????? ???????????, ???????????? ???? ????? ??????????? ??? ?????? ?????????? ???????? ???????
#define TEMPERATURE_OVER 550
// ???????? ??????????? ??????????????? ??????? ???????? ???????
#define TEMPERATURE_TABLE_START 0
// ??? ??????? 
#define TEMPERATURE_TABLE_STEP 5

// ??? ??????? ???????? ? ???????, ???? ????? ??????? ? ???????? 16 ??? - uint16_t, ????? - uint32_t
typedef uint16_t temperature_table_entry_type;
// ??? ??????? ???????. ???? ? ??????? ?????? 256 ?????????, ?? uint16_t, ????? - uint8_t
typedef uint8_t temperature_table_index_type;
// ????? ??????? ? ???????? ???????, ?????? ??????????????? temperature_table_entry_type
#define TEMPERATURE_TABLE_READ(i) pgm_read_word(&termo_table[i])

/* ??????? ?????????? ???????? ??? ? ??????????? ?? ???????????. ?? ???????? ???????? ? ????????
   ??? ?????????? ??????? ???????????? ????????? ??????????:
     R1(T1): 10???(25°?)
     ??????? R/T ?????????????: EPCOS R/T:2904; B25/100:4300K
     ????? ?????????: A
     Ra: 10???
     ?????????? U0/Uref: 3?/3?
*/
const temperature_table_entry_type termo_table[] = {
    3197, 3178, 3158, 3138, 3118, 3097, 3077, 3056,
    3035, 3014, 2993, 2971, 2949, 2927, 2905, 2883,
    2860, 2837, 2815, 2792, 2769, 2746, 2722, 2699,
    2676, 2652, 2628, 2605, 2581, 2557, 2533, 2509,
    2485, 2460, 2436, 2412, 2388, 2363, 2339, 2315,
    2290, 2266, 2241, 2217, 2193, 2169, 2144, 2120,
    2096, 2072, 2048, 2024, 2000, 1976, 1953, 1929,
    1906, 1882, 1859, 1836, 1813, 1790, 1767, 1744,
    1721, 1698, 1676, 1653, 1631, 1609, 1587, 1566,
    1544, 1523, 1502, 1481, 1460, 1439, 1419, 1399,
    1379, 1359, 1340, 1320, 1301, 1283, 1264, 1246,
    1227, 1209, 1192, 1174, 1157, 1139, 1122, 1105,
    1089, 1073, 1056, 1040, 1025, 1009, 993, 978,
    963, 948, 934, 919, 905, 891, 877
};

// ??????? ????????? ???????? ??????????? ? ??????? ????? ???????? ???????
// ? ??????????? ?? ?????????? ???????? ???.
int16_t calc_temperature(temperature_table_entry_type adcsum) {
  temperature_table_index_type l = 0;
  temperature_table_index_type r = (sizeof(termo_table) / sizeof(termo_table[0])) - 1;
  temperature_table_entry_type thigh = TEMPERATURE_TABLE_READ(r);
  
  // ???????? ?????? ?? ??????? ? ????????? ????????
  if (adcsum <= thigh) {
    #ifdef TEMPERATURE_UNDER
      if (adcsum < thigh) 
        return TEMPERATURE_UNDER;
    #endif
    return TEMPERATURE_TABLE_STEP * r + TEMPERATURE_TABLE_START;
  }
  temperature_table_entry_type tlow = TEMPERATURE_TABLE_READ(0);
  if (adcsum >= tlow) {
    #ifdef TEMPERATURE_OVER
      if (adcsum > tlow)
        return TEMPERATURE_OVER;
    #endif
    return TEMPERATURE_TABLE_START;
  }

  // ???????? ????? ?? ???????
  while ((r - l) > 1) {
    temperature_table_index_type m = (l + r) >> 1;
    temperature_table_entry_type mid = TEMPERATURE_TABLE_READ(m);
    if (adcsum > mid) {
      r = m;
    } else {
      l = m;
    }
  }
  temperature_table_entry_type vl = TEMPERATURE_TABLE_READ(l);
  if (adcsum >= vl) {
    return l * TEMPERATURE_TABLE_STEP + TEMPERATURE_TABLE_START;
  }
  temperature_table_entry_type vr = TEMPERATURE_TABLE_READ(r);
  temperature_table_entry_type vd = vl - vr;
  int16_t res = TEMPERATURE_TABLE_START + r * TEMPERATURE_TABLE_STEP; 
  if (vd) {
    // ???????? ????????????
    res -= ((TEMPERATURE_TABLE_STEP * (int32_t)(adcsum - vr) + (vd >> 1)) / vd);
  }
  return res;
}